<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Player 2 – Guesser</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='webrtc.js') }}"></script>
</head>

<body>
    <header>
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height:80px;">
    </header>

    <main style="width: 100%; max-width: 900px; text-align: center;">
        <h2>Player 2 – Guesser</h2>
        <div id="game-info" style="margin-bottom: 1em; color: #555;"></div>

        <!-- Card grid -->
        <div id="card-grid">
            {% for card in cards %}
            <div class="card{% if card.id in eliminated %} eliminated{% endif %}" id="card{{ card.id }}"
                onclick="eliminateCard('{{ card.id }}')">
                <img src="{{ url_for('static', filename='cards/' + card.id|string + '.png') }}" alt="{{ card.name }}">
            </div>
            {% endfor %}
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 700px; margin: 0 auto;">
            <h3 class="chat-title">Chat</h3>
            <div id="transcript"></div>

            <div class="chat-bar">
                <input type="text" id="chat-input" placeholder="Send a message to all participants">
                <button id="send-btn">Send</button>
            </div>
        </div>

        <div class="voice-controls" style="margin-top: 10px;">
            <button id="voice-toggle">Join voice</button>
            <span id="voice-status" style="margin-left: 8px; color: #555;">idle</span>
            <audio id="remote-audio" hidden></audio>
        </div>
    </main>

    <script>
        // --- Setup -----------------------------------------------------
        const gameId = new URLSearchParams(window.location.search).get('game_id') || 'default';
        document.getElementById('game-info').textContent = `Game ID: ${gameId}`;

        const socket = io();
        socket.emit('join', {game_id: gameId, role: 'player2', participant_id: window.participantId});

        const transcriptDiv = document.getElementById('transcript');
        const chatInput = document.getElementById('chat-input');

        // Track seen joins by role to avoid duplicate join messages in UI
        const seenJoins = new Set();

        // --- Helper functions ------------------------------------------
        function appendMessage(msg, style = '') {
            const div = document.createElement('div');
            div.innerHTML = msg;
            if (style) div.style = style;
            transcriptDiv.appendChild(div);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        // --- Chat -------------------------------------------------------
        const sendChat = () => {
            const text = chatInput.value.trim();
            if (!text) return;
            socket.emit('chat', {game_id: gameId, role: 'player2', text, participant_id: window.participantId});
            chatInput.value = '';
        };

        document.getElementById('send-btn').onclick = sendChat;
        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChat();
            }
        });

        socket.on('chat', data => {
            appendMessage(`<b>${data.role}:</b> ${data.text}`);
        });

        socket.on('system', data => {
            // Suppress duplicate join messages (same role appearing multiple times)
            if (data.action === 'join') {
                const key = `${data.role}`;
                if (seenJoins.has(key)) return;  // Already saw this role join
                seenJoins.add(key);
            }
            appendMessage(`<em>${data.role || 'System'} joined game ${data.game_id}</em>`, 'color:gray;');
        });

        // --- Elimination logic -----------------------------------------
        function eliminateCard(cardId) {
            fetch('/eliminate_card', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({game_id: gameId, card_id: cardId})
            }).catch(err => console.error('Failed to eliminate:', err));
        }

        socket.on('eliminate', data => {
            const eliminatedIds = data.eliminated || [];
            appendMessage(`<em>Eliminated cards: ${eliminatedIds.join(', ')}</em>`, 'color:red;');
            eliminatedIds.forEach(id => {
                const cardEl = document.getElementById(`card${id}`);
                if (cardEl) cardEl.classList.add('eliminated');
            });
        });

        // --- Voice (WebRTC) -------------------------------------------
        setupVoice({
            socket,
            gameId,
            role: 'player2',
            buttonEl: document.getElementById('voice-toggle'),
            statusEl: document.getElementById('voice-status'),
            remoteAudioEl: document.getElementById('remote-audio')
        });
    </script>
</body>

</html>