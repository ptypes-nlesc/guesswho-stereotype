<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Player 1 – Secret Card</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='webrtc.js') }}"></script>
</head>

<body>
    <header>
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height:80px;">
    </header>

    <main style="width: 100%; max-width: 700px; text-align: center;">
        <h2>Player 1 – Secret Card</h2>
        <div id="game-info" style="margin-bottom: 1em; color: #555;"></div>

        <div class="secret-card">
            <img src="{{ url_for('static', filename='cards/' + card.id|string + '.png') }}" alt="{{ card.name }}"
                class="secret-card-image">
            <p><strong>Your Secret Card:</strong> {{ card.name }}</p>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
            <h3 class="chat-title" style="align-self: flex-start;">Chat</h3>
            <div id="transcript"></div>

            <div class="chat-bar">
                <input type="text" id="chat-input" placeholder="Send a message to all participants">
                <button id="send-btn">Send</button>
            </div>
        </div>

        <div class="voice-controls" style="margin-top: 10px;">
            <button id="voice-toggle">Join voice</button>
            <span id="voice-status" style="margin-left: 8px; color: #555;">idle</span>
            <audio id="remote-audio" hidden></audio>
        </div>
    </main>

    <script>
        // --- Setup -----------------------------------------------------
        const gameId = new URLSearchParams(window.location.search).get('game_id') || 'default';
        const participantId = new URLSearchParams(window.location.search).get('participant_id');
        document.getElementById('game-info').textContent = `Game ID: ${gameId}`;

        const transcriptDiv = document.getElementById('transcript');
        const chatInput = document.getElementById('chat-input');
        const socket = io();

        socket.emit('join', {game_id: gameId, role: 'player1', participant_id: participantId});

        // Track seen joins by role to avoid duplicate join messages in UI
        const seenJoins = new Set();

        // --- Game Status Polling -----------------------------------------------
        let gameEnded = false;
        
        async function checkGameStatus() {
            try {
                const params = new URLSearchParams();
                params.append('game_id', gameId);
                if (participantId) {
                    params.append('participant_id', participantId);
                }
                const res = await fetch(`/game/status?${params}`);
                const data = await res.json();
                
                if (data.state === 'ENDED' || data.state === 'CLOSED') {
                    if (!gameEnded) {
                        gameEnded = true;
                        // Disable interactions
                        document.getElementById('chat-input').disabled = true;
                        document.getElementById('send-btn').disabled = true;
                        document.getElementById('voice-toggle').disabled = true;
                        document.getElementById('voice-toggle').style.opacity = '0.6';
                        document.getElementById('voice-toggle').style.cursor = 'not-allowed';
                        
                        const endNotification = document.createElement('div');
                        endNotification.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 8px; margin-top: 20px; text-align: center; font-size: 1.2em; font-weight: bold; color: #856404;';
                        endNotification.innerHTML = '✅ Game has ended. Thank you for playing!<br><small style="font-size: 0.8em; display: block; margin-top: 10px;">You can close this window.</small>';
                        
                        const main = document.querySelector('main');
                        if (main && !document.querySelector('[data-game-ended]')) {
                            main.appendChild(endNotification);
                            endNotification.setAttribute('data-game-ended', 'true');
                        }
                    }
                    
                    // Stop polling after game ends
                    if (gameStatusInterval) {
                        clearInterval(gameStatusInterval);
                    }
                }
            } catch (err) {
                console.error('Game status check failed:', err);
            }
        }
        
        // Check immediately on load
        checkGameStatus();
        
        // Then set up polling every 2 seconds
        const gameStatusInterval = setInterval(checkGameStatus, 2000);

        // --- Chat sending ----------------------------------------------
        const sendChat = () => {
            const text = chatInput.value.trim();
            if (!text) return;
            socket.emit('chat', {game_id: gameId, role: 'player1', text, participant_id: participantId});
            chatInput.value = '';
        };

        document.getElementById('send-btn').onclick = sendChat;
        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChat();
            }
        });

        // --- Helper to add transcript lines -----------------------------
        function appendMessage(msg, style = '') {
            const div = document.createElement('div');
            div.innerHTML = msg;
            if (style) div.style = style;
            transcriptDiv.appendChild(div);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        // --- Incoming messages ------------------------------------------
        socket.on('chat', data => {
            appendMessage(`<b>${data.role}:</b> ${data.text}`);
        });

        socket.on('system', data => {
            // Suppress duplicate join messages (same role appearing multiple times)
            if (data.action === 'join') {
                const key = `${data.role}`;
                if (seenJoins.has(key)) return;  // Already saw this role join
                seenJoins.add(key);
            }
            appendMessage(`<em>${data.role || 'System'} joined game ${data.game_id}</em>`, 'color:gray;');
        });

        // Player 1 does not receive elimination messages - only moderator and player2 should see them

        // --- Voice (WebRTC) -------------------------------------------
        setupVoice({
            socket,
            gameId,
            role: 'player1',
            buttonEl: document.getElementById('voice-toggle'),
            statusEl: document.getElementById('voice-status'),
            remoteAudioEl: document.getElementById('remote-audio')
        });
    </script>
</body>

</html>