<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Player 1 – Secret Card</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='webrtc.js') }}"></script>
</head>

<body>
    <header>
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height:80px;">
    </header>

    <main style="width: 100%; max-width: 700px; text-align: center;">
        <h2>Player 1 – Secret Card</h2>
        <div id="game-info" style="margin-bottom: 1em; color: #555;"></div>

        <div class="secret-card">
            <img src="{{ url_for('static', filename='cards/' + card.id|string + '.png') }}" alt="{{ card.name }}"
                class="secret-card-image">
            <p><strong>Your Secret Card:</strong> {{ card.name }}</p>
        </div>

        <h3>Transcript</h3>
        <div id="transcript"></div>

        <div class="voice-controls" style="margin-top: 10px;">
            <button id="voice-toggle">Join voice</button>
            <span id="voice-status" style="margin-left: 8px; color: #555;">idle</span>
            <audio id="remote-audio" hidden></audio>
        </div>

        <div class="chat-bar">
            <input type="text" id="chat-input" placeholder="Send a message to all participants">
            <button id="send-btn">Send</button>
        </div>
    </main>

    <script>
        // --- Setup -----------------------------------------------------
        const gameId = new URLSearchParams(window.location.search).get('game_id') || 'default';
        document.getElementById('game-info').textContent = `Game ID: ${gameId}`;

        const transcriptDiv = document.getElementById('transcript');
        const chatInput = document.getElementById('chat-input');
        const socket = io();

        socket.emit('join', {game_id: gameId, role: 'player1', participant_id: window.participantId});

        // Track seen joins by role to avoid duplicate join messages in UI
        const seenJoins = new Set();

        // --- Chat sending ----------------------------------------------
        document.getElementById('send-btn').onclick = () => {
            const text = chatInput.value.trim();
            if (!text) return;
            socket.emit('chat', {game_id: gameId, role: 'player1', text, participant_id: window.participantId});
            chatInput.value = '';
        };

        // --- Helper to add transcript lines -----------------------------
        function appendMessage(msg, style = '') {
            const div = document.createElement('div');
            div.innerHTML = msg;
            if (style) div.style = style;
            transcriptDiv.appendChild(div);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        // --- Incoming messages ------------------------------------------
        socket.on('chat', data => {
            appendMessage(`<b>${data.role}:</b> ${data.text}`);
        });

        socket.on('system', data => {
            // Suppress duplicate join messages (same role appearing multiple times)
            if (data.action === 'join') {
                const key = `${data.role}`;
                if (seenJoins.has(key)) return;  // Already saw this role join
                seenJoins.add(key);
            }
            appendMessage(`<em>${data.role || 'System'} joined game ${data.game_id}</em>`, 'color:gray;');
        });

        socket.on('eliminate', data => {
            appendMessage(`<em>Player 2 eliminated card ${data.card}</em>`, 'color:red;');
        });

        // --- Voice (WebRTC) -------------------------------------------
        setupVoice({
            socket,
            gameId,
            role: 'player1',
            buttonEl: document.getElementById('voice-toggle'),
            statusEl: document.getElementById('voice-status'),
            remoteAudioEl: document.getElementById('remote-audio')
        });
    </script>
</body>

</html>