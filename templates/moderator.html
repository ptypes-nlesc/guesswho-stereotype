<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Moderator View – GuessWho Stereotype</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='webrtc.js') }}"></script>
</head>

<body>
    <header>
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height:80px;">
    </header>

    <main class="moderator-main">
        <div class="header-bar">
            <h2>Moderator View</h2>
            <span class="game-info">Game ID: <span id="game-id-display">{{ game_id }}</span></span>
        </div>

        <div class="player-panels">
            <div class="player-box">
                <h3>Player 1 (Secret Card)</h3>
                <iframe id="p1frame" title="Player 1 View"></iframe>
            </div>

            <div class="player-box">
                <h3>Player 2 (Guesser)</h3>
                <iframe id="p2frame" title="Player 2 View"></iframe>
            </div>
        </div>

        <h3 class="transcript-title">Transcript</h3>
        <div id="transcript"></div>

        <div class="chat-bar wide">
            <input type="text" id="chat-input" placeholder="Send a message to all participants">
            <button id="send-chat">Send</button>
        </div>

        <div class="voice-controls" style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
            <button id="voice-toggle">Join voice</button>
            <span id="voice-status" style="color: #555;">idle</span>
            <audio id="remote-audio" hidden></audio>
        </div>

        <footer>
            <p>Moderator controls and monitoring panel – GuessWho Stereotype</p>
            <p><a href="{{ url_for('dashboard') }}" class="link-btn">⬅ Back to Dashboard</a></p>
        </footer>
    </main>

    <script>
        // --- Setup -----------------------------------------------------
        const gameId = new URLSearchParams(window.location.search).get('game_id') || '{{ game_id }}';
        document.getElementById("game-id-display").textContent = gameId;

        // Inject player iframes
        const setIframeSources = () => {
            document.getElementById("p1frame").src = `/player1?game_id=${gameId}`;
            document.getElementById("p2frame").src = `/player2?game_id=${gameId}`;
        };
        setIframeSources();

        // --- Socket setup ---------------------------------------------
        const socket = io();
        socket.emit("join", {game_id: gameId, role: "moderator"});

        const transcriptDiv = document.getElementById("transcript");
        const chatInput = document.getElementById("chat-input");

        // --- Helpers --------------------------------------------------
        function appendMessage(msg, style = "") {
            const div = document.createElement("div");
            div.innerHTML = msg;
            if (style) div.style = style;
            transcriptDiv.appendChild(div);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        // --- Chat send ------------------------------------------------
        document.getElementById("send-chat").onclick = () => {
            const text = chatInput.value.trim();
            if (!text) return;
            socket.emit("chat", {game_id: gameId, role: "moderator", text});
            chatInput.value = "";
        };

        // --- Socket events --------------------------------------------
        socket.on("chat", data => appendMessage(`<b>${data.role}:</b> ${data.text}`));
        socket.on("system", data => appendMessage(`<em>${data.role || "System"} joined game ${data.game_id}</em>`, "color:gray;"));
        socket.on("eliminate", data => appendMessage(`<em>Eliminated cards: ${data.eliminated.join(", ")}</em>`, "color:red;"));

        // --- Voice (WebRTC) -------------------------------------------
        setupVoice({
            socket,
            gameId,
            role: "moderator",
            buttonEl: document.getElementById("voice-toggle"),
            statusEl: document.getElementById("voice-status"),
            remoteAudioEl: document.getElementById("remote-audio"),
        });
    </script>
</body>

</html>