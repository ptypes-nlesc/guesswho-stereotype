<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Moderator View – GuessWho Stereotype</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='webrtc.js') }}"></script>
</head>

<body>
    <header>
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="height:80px;">
    </header>

    <main class="moderator-main">
        <div class="header-bar">
            <h2>Moderator View</h2>
            <span class="game-info">Game ID: <span id="game-id-display">{{ game_id }}</span></span>
        </div>

        <div class="player-panels">
            <div class="player-box">
                <h3>Player 1 (Secret Card)</h3>
                {% if secret_card is defined %}
                <div class="secret-card">
                    <img src="{{ url_for('static', filename='cards/' + secret_card.id|string + '.png') }}" alt="{{ secret_card.name }}"
                        class="secret-card-image">
                    <p><strong>Secret Card:</strong> {{ secret_card.name }}</p>
                </div>
                {% else %}
                <p style="color: #999;">Secret card not available.</p>
                {% endif %}
            </div>

            <div class="player-box">
                <h3>Player 2 (Guesser Grid)</h3>
                <div id="card-grid">
                    {% for card_item in cards|default([]) %}
                    <div class="card{% if card_item.id in (eliminated|default([])) %} eliminated{% endif %}" id="card{{ card_item.id }}">
                        <img src="{{ url_for('static', filename='cards/' + card_item.id|string + '.png') }}" alt="{{ card_item.name }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <h3 class="transcript-title">Transcript</h3>
        <div id="transcript"></div>

        <div class="chat-bar wide">
            <input type="text" id="chat-input" placeholder="Send a message to all participants">
            <button id="send-chat">Send</button>
        </div>

        <div class="voice-controls" style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
            <button id="voice-toggle">Join voice</button>
            <span id="voice-status" style="color: #555;">idle</span>
            <audio id="remote-audio" hidden></audio>
        </div>

        <footer>
            <p>Moderator controls and monitoring panel – GuessWho Stereotype</p>
            <p><a href="{{ url_for('dashboard') }}" class="link-btn">⬅ Back to Dashboard</a></p>
        </footer>
    </main>

    <script>
        // --- Setup -----------------------------------------------------
        const gameId = new URLSearchParams(window.location.search).get('game_id') || '{{ game_id }}';
        document.getElementById("game-id-display").textContent = gameId;

        // --- Socket setup ---------------------------------------------
        const socket = io();
        socket.emit("join", {game_id: gameId, role: "moderator", participant_id: window.participantId});

        const transcriptDiv = document.getElementById("transcript");
        const chatInput = document.getElementById("chat-input");

        // Track seen joins by role to avoid duplicate join messages in UI
        const seenJoins = new Set();

        // --- Helpers --------------------------------------------------
        function appendMessage(msg, style = "") {
            const div = document.createElement("div");
            div.innerHTML = msg;
            if (style) div.style = style;
            transcriptDiv.appendChild(div);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        // --- Chat send ------------------------------------------------
        document.getElementById("send-chat").onclick = () => {
            const text = chatInput.value.trim();
            if (!text) return;
            socket.emit("chat", {game_id: gameId, role: "moderator", text, participant_id: window.participantId});
            chatInput.value = "";
        };

        // --- Socket events --------------------------------------------
        socket.on("chat", data => appendMessage(`<b>${data.role}:</b> ${data.text}`));
        socket.on("system", data => {
            if (data.action === "join") {
                const key = `${data.role}`;
                if (seenJoins.has(key)) return;
                seenJoins.add(key);
            }
            appendMessage(`<em>${data.role || "System"} joined game ${data.game_id}</em>`, "color:gray;");
        });
        socket.on("eliminate", data => {
            const eliminatedIds = data.eliminated || [];
            appendMessage(`<em>Eliminated cards: ${eliminatedIds.join(", ")}</em>`, "color:red;");
            eliminatedIds.forEach(id => {
                const cardEl = document.getElementById(`card${id}`);
                if (cardEl) cardEl.classList.add("eliminated");
            });
        });

        // --- Voice (WebRTC) -------------------------------------------
        setupVoice({
            socket,
            gameId,
            role: "moderator",
            buttonEl: document.getElementById("voice-toggle"),
            statusEl: document.getElementById("voice-status"),
            remoteAudioEl: document.getElementById("remote-audio"),
        });
    </script>
</body>

</html>